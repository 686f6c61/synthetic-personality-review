---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Icon from '../../components/Icon.astro';
import { getSourceLabel, loadCanonicalArticles } from '../../lib/data';

export function getStaticPaths() {
  const articles = loadCanonicalArticles();
  return articles.map((article) => ({
    params: { id: article.id },
    props: { article }
  }));
}

const { article } = Astro.props;
const esRaw = article.resumen_es_extendido?.trim() || '';
const enRaw = article.abstract_en_extended?.trim() || article.abstract_en_original?.trim() || '';
const esParagraphs = esRaw.split(/\n\s*\n/).filter(Boolean);
const enParagraphs = enRaw.split(/\n\s*\n/).filter(Boolean);
const sourceLabel = getSourceLabel(article.source_url, article.source_type);
const descriptionSource = esParagraphs[0] || enParagraphs[0] || article.abstract_en_original || '';
const descriptionCompact = descriptionSource.replace(/\s+/g, ' ').trim();
const pageDescription =
  descriptionCompact.length > 210 ? `${descriptionCompact.slice(0, 207).trimEnd()}...` : descriptionCompact;
const publishedTime = `${article.year}-01-01T00:00:00Z`;
const modifiedTime = article.verification_date || publishedTime;
const articleUrl = new URL(`/articles/${article.id}`, 'https://syntheticpersonality.com').toString();
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'ScholarlyArticle',
  headline: article.title_canonical,
  name: article.title_canonical,
  inLanguage: article.language === 'Inglés' ? 'en' : 'es',
  datePublished: `${article.year}-01-01`,
  dateModified: modifiedTime.slice(0, 10),
  author: article.authors.map((author: string) => ({
    '@type': 'Person',
    name: author
  })),
  keywords: article.keywords,
  url: articleUrl,
  sameAs: article.source_url,
  isPartOf: {
    '@type': 'WebSite',
    name: 'Synthetic Personality Review',
    url: 'https://syntheticpersonality.com/'
  }
};
---

<BaseLayout
  title={`${article.title_canonical} | Synthetic Personality Review`}
  description={pageDescription}
  ogType="article"
  keywords={[...article.keywords, article.category, '«personalidad sintética»']}
  structuredData={structuredData}
  publishedTime={publishedTime}
  modifiedTime={modifiedTime}
>
  <section class="hero">
    <h1>{article.title_canonical}</h1>
    <div class="meta">
      <span class="badge warn">{article.category}</span>
      <span class="badge warn">{article.year}</span>
      <span class="badge warn">{sourceLabel}</span>
    </div>
    <div class="detail-meta">
      <p class="detail-meta-row">
        <Icon name="network" class="detail-meta-icon" />
        <span><strong>Línea:</strong> {article.category}</span>
      </p>
      <p class="detail-meta-row">
        <Icon name="type" class="detail-meta-icon" />
        <span><strong>Título original:</strong> {article.title_original}</span>
      </p>
      <p class="detail-meta-row">
        <Icon name="users" class="detail-meta-icon" />
        <span><strong>Autores:</strong> {article.authors.join(', ')}</span>
      </p>
      <p class="detail-meta-row">
        <Icon name="tags" class="detail-meta-icon" />
        <span><strong>Palabras clave:</strong> {article.keywords.join(', ')}</span>
      </p>
      <p class="detail-meta-row">
        <Icon name="link" class="detail-meta-icon" />
        <span>
          <strong>Fuente:</strong>
          <a href={article.source_url} target="_blank" rel="noreferrer"> {article.source_url} </a>
        </span>
      </p>
    </div>
  </section>

  <section class="section">
    <h2>Resúmenes</h2>
    <div class="abstract-grid">
      <article class="abstract-panel">
        <p class="abstract-label">Español</p>
        <div class="article-content">
          {esParagraphs.length > 0 ? (
            esParagraphs.map((paragraph) => <p class="abstract-paragraph">{paragraph}</p>)
          ) : (
            <p class="muted">No hay resumen disponible en español para este artículo.</p>
          )}
        </div>
      </article>

      <article class="abstract-panel">
        <p class="abstract-label">Inglés</p>
        <div class="article-content">
          {enParagraphs.length > 0 ? (
            enParagraphs.map((paragraph) => <p class="abstract-paragraph">{paragraph}</p>)
          ) : (
            <p class="muted">No hay abstract disponible en inglés para este artículo.</p>
          )}
        </div>
      </article>
    </div>
  </section>
</BaseLayout>
