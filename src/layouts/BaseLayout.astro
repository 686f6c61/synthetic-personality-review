---
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
  canonical?: string;
  ogImage?: string;
  ogType?: 'website' | 'article';
  keywords?: string[];
  noindex?: boolean;
  structuredData?: Record<string, unknown> | Array<Record<string, unknown>>;
  publishedTime?: string;
  modifiedTime?: string;
}

const {
  title,
  description = 'Repositorio editorial y literatura de trabajo sobre «personalidad sintética» en LLMs.',
  canonical,
  ogImage = '/assets/og-default.png',
  ogType = 'website',
  keywords = [],
  noindex = false,
  structuredData,
  publishedTime,
  modifiedTime
} = Astro.props;

const site = Astro.site ?? new URL('https://syntheticpersonality.com');
const canonicalUrl = canonical ?? new URL(Astro.url.pathname, site).toString();
const ogImageUrl = ogImage.startsWith('http') ? ogImage : new URL(ogImage, site).toString();
const rssUrl = new URL('/rss.xml', site).toString();
const sitemapUrl = new URL('/sitemap.xml', site).toString();

const defaultKeywords = [
  'personalidad en LLM',
  'personalidad IA',
  '«personalidad sintética»',
  'evaluación de «personalidad sintética»',
  '«personalidad sintética» en modelos de lenguaje',
  'evaluación psicométrica LLM',
  'Synthetic Personality Review',
  'literatura personalidad modelos de lenguaje'
];

const keywordsContent = [...new Set([...defaultKeywords, ...keywords].map((item) => item.trim()).filter(Boolean))].join(', ');
const robotsContent = noindex
  ? 'noindex, nofollow'
  : 'index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1';

const structuredDataList = Array.isArray(structuredData)
  ? structuredData
  : structuredData
    ? [structuredData]
    : [];
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="keywords" content={keywordsContent} />
    <meta name="author" content="686f6c61" />
    <meta name="robots" content={robotsContent} />
    <meta name="theme-color" content="#111111" />
    <meta name="generator" content={Astro.generator} />

    <link rel="canonical" href={canonicalUrl} />
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/logo-180.png" />
    <link rel="alternate" type="application/rss+xml" title="Synthetic Personality Review RSS" href={rssUrl} />
    <link rel="sitemap" type="application/xml" href={sitemapUrl} />

    <meta property="og:type" content={ogType} />
    <meta property="og:site_name" content="Synthetic Personality Review" />
    <meta property="og:locale" content="es_ES" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="Synthetic Personality Review: evaluación de «personalidad sintética» en modelos de lenguaje" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageUrl} />
    <meta name="twitter:site" content="@hex686f6c61" />

    {ogType === 'article' && publishedTime && <meta property="article:published_time" content={publishedTime} />}
    {ogType === 'article' && modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}

    {structuredDataList.map((schema) => (
      <script type="application/ld+json" set:html={JSON.stringify(schema)} />
    ))}

    <title>{title}</title>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a href="/" class="brand">
          <img class="brand-logo" src="/assets/logo-64.png" alt="Synthetic Personality Review" width="32" height="32" loading="eager" decoding="async" />
          <span class="brand-text">Synthetic Personality Review</span>
        </a>
        <nav>
          <a href="/articles">
            <svg class="nav-icon" viewBox="0 0 24 24" aria-hidden="true">
              <rect x="3" y="4" width="18" height="16" rx="2"></rect>
              <path d="M7 8h10M7 12h10M7 16h6"></path>
            </svg>
            <span>Artículos</span>
          </a>
        </nav>
      </div>
    </header>
    <main class="container">
      <slot />
    </main>
    <footer class="site-footer container">
      <div class="footer-row">
        <div class="footer-signature">
          <img class="footer-logo" src="/assets/logo-64.png" alt="" width="24" height="24" loading="lazy" decoding="async" />
          <span>686f6c61</span>
          <span aria-hidden="true">·</span>
          <span>2026</span>
        </div>
        <div class="footer-links">
          <button class="footer-link footer-mail-trigger" type="button" id="mailReveal" aria-controls="mailLink" aria-expanded="false">
            <svg class="footer-icon" viewBox="0 0 24 24" aria-hidden="true">
              <rect x="3" y="5" width="18" height="14" rx="2"></rect>
              <path d="m3 7 9 7 9-7"></path>
            </svg>
            <span data-mail-label>Correo</span>
          </button>
          <a class="footer-link footer-mail-link is-hidden" id="mailLink" href="#" hidden rel="nofollow noopener noreferrer">
            <svg class="footer-icon" viewBox="0 0 24 24" aria-hidden="true">
              <rect x="3" y="5" width="18" height="14" rx="2"></rect>
              <path d="m3 7 9 7 9-7"></path>
            </svg>
            <span data-mail-value>correo</span>
          </a>
          <a class="footer-link" href="https://github.com/686f6c61" target="_blank" rel="noopener noreferrer">
            <span>GitHub</span>
          </a>
          <a class="footer-link" href="https://x.com/hex686f6c61" target="_blank" rel="noopener noreferrer">
            <span>X</span>
          </a>
        </div>
      </div>
    </footer>
    <script>
      (() => {
        const trigger = document.getElementById('mailReveal');
        const link = document.getElementById('mailLink');
        if (!trigger || !link) return;
        const triggerLabel = trigger.querySelector('[data-mail-label]');
        const linkValue = link.querySelector('[data-mail-value]');

        const encoded = [105, 105, 104, 86, 101, 21, 21, 71, 11, 81, 64, 70, 77];
        const key = 37;
        let clicks = 0;
        let resetTimer;

        const decodeEmail = () =>
          encoded.map((value) => String.fromCharCode(value ^ key)).join('');

        const resetClicks = () => {
          clicks = 0;
          if (triggerLabel) {
            triggerLabel.textContent = 'Correo';
          }
        };

        trigger.addEventListener('click', () => {
          clicks += 1;
          clearTimeout(resetTimer);
          resetTimer = setTimeout(resetClicks, 1250);

          if (clicks < 3) {
            if (triggerLabel) {
              triggerLabel.textContent = `Correo (${clicks}/3)`;
            }
            return;
          }

          const email = decodeEmail();
          if (linkValue) {
            linkValue.textContent = email;
          }
          link.setAttribute('href', `mailto:${email}`);
          link.hidden = false;
          link.classList.remove('is-hidden');
          trigger.setAttribute('aria-expanded', 'true');
          resetClicks();
        });
      })();
    </script>
  </body>
</html>
